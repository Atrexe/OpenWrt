#!/bin/sh

[ "$DEVTYPE" = "partition" ] || exit

DEVICE="$DEVNAME"
case "$DEVICE" in
sd*) ;;
md*) ;;
hd*) ;;
mmcblk*) ;;
*) exit ;;
esac

[ -f /var/run/config/samba ] || {
	mkdir -p /var/run/config && touch /var/run/config/samba
}

mkdir -p /var/lock
lock /var/lock/autosamba.lock

[ "$ACTION" = "add" ] && {
	mount=$(grep "^/dev/${DEVICE}[[:space:]]" /proc/mounts | awk 'NR==1{print $2}')
	uuid="$(block info | grep "^/dev/${DEVICE}:[[:space:]]\+" | awk -F "[[:space:]]UUID=\"" '{print $2}' | awk -F "\"" '{print $1}' | tr 'A-Z' 'a-z' | sed 's/[^0-9a-z]//g')"
	[ -n "$mount" ] && [ -n "$uuid" ] && {
		uuid="00000$uuid"
		label="auto_share_${uuid:0-6}"
		uci -q -c /var/run/config batch <<-EOF
			set samba.$DEVICE="sambashare"
			set samba.$DEVICE.name="$label"
			set samba.$DEVICE.path="$mount"
			set samba.$DEVICE.browseable="yes"
			set samba.$DEVICE.read_only="no"
			set samba.$DEVICE.guest_ok="yes"
			set samba.$DEVICE.create_mask="0666"
			set samba.$DEVICE.dir_mask="0777"
			commit samba
		EOF
		/etc/init.d/samba reload
	}
}

[ "$ACTION" = "remove" ] && {
	uci -q -c /var/run/config batch <<-EOF
		delete samba.$DEVICE
		commit samba
	EOF
	/etc/init.d/samba reload
}

lock -u /var/lock/autosamba.lock
